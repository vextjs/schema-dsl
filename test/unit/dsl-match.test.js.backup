/**
 * DSL Match è¯­æ³•æµ‹è¯•
 */

const { expect } = require('chai');
const { dsl, validate } = require('../../index');

describe('DSL Match è¯­æ³• (v2.1.0)', () => {

  describe('dsl.match', () => {
    it('åº”è¯¥æ”¯æŒåŸºæœ¬çš„ match è¯­æ³•', () => {
      const schema = dsl({
        type: 'string',
        value: dsl.match('type', {
          email: 'email!',
          phone: 'string:11!',
          _default: 'string'
        })
      });

      // Case 1: type=email
      expect(validate(schema, { type: 'email', value: 'test@example.com' }).valid).to.be.true;
      expect(validate(schema, { type: 'email', value: 'invalid-email' }).valid).to.be.false;

      // Case 2: type=phone
      expect(validate(schema, { type: 'phone', value: '13800138000' }).valid).to.be.true;
      expect(validate(schema, { type: 'phone', value: '123456789012' }).valid).to.be.false;

      // Case 3: default
      expect(validate(schema, { type: 'other', value: 'any string' }).valid).to.be.true;
    });

    it('åº”è¯¥æ”¯æŒéžè‹±æ–‡å€¼ï¼ˆå¸¦å¼•å·ï¼‰', () => {
      const schema = dsl({
        level: 'string',
        discount: dsl.match('level', {
          'æ™®é€šç”¨æˆ·': 'number:0-5',
          'VIP-1': 'number:0-20',
          '100': 'number:0-50'
        })
      });

      expect(validate(schema, { level: 'æ™®é€šç”¨æˆ·', discount: 3 }).valid).to.be.true;
      expect(validate(schema, { level: 'æ™®é€šç”¨æˆ·', discount: 10 }).valid).to.be.false;

      expect(validate(schema, { level: 'VIP-1', discount: 15 }).valid).to.be.true;
      expect(validate(schema, { level: '100', discount: 40 }).valid).to.be.true;
    });

    it('åº”è¯¥æ”¯æŒåµŒå¥—å¯¹è±¡ä½œä¸ºè§„åˆ™', () => {
      const schema = dsl({
        type: 'string',
        config: dsl.match('type', {
          db: {
            host: 'string!',
            port: 'number!'
          },
          api: {
            url: 'url!',
            token: 'string'
          }
        })
      });

      expect(validate(schema, {
        type: 'db',
        config: { host: 'localhost', port: 3306 }
      }).valid).to.be.true;

      expect(validate(schema, {
        type: 'api',
        config: { url: 'https://api.example.com' }
      }).valid).to.be.true;
    });
  });

  describe('dsl.if', () => {
    it('åº”è¯¥æ”¯æŒåŸºæœ¬çš„ if è¯­æ³•', () => {
      const schema = dsl({
        isVip: 'boolean',
        discount: dsl.if('isVip', 'number:0-50', 'number:0-10')
      });

      expect(validate(schema, { isVip: true, discount: 40 }).valid).to.be.true;
      expect(validate(schema, { isVip: false, discount: 40 }).valid).to.be.false;
      expect(validate(schema, { isVip: false, discount: 5 }).valid).to.be.true;
    });
  });

  describe('dsl() åŒ…è£¹ (v1.0.6)', () => {
    it('åº”è¯¥æ”¯æŒåœ¨ dsl.match å€¼ä¸­ä½¿ç”¨ dsl() åŒ…è£¹', () => {
      const schema = dsl({
        payment_type: 'string',
        price: dsl.match('payment_type', {
          'cash': dsl('number:0.99-1000!').label('çŽ°é‡‘ä»·æ ¼').messages({ required: 'ä»·æ ¼å¿…å¡«' }),
          'card': dsl('number:0.99-2000!').label('åˆ·å¡ä»·æ ¼'),
          '_default': 'number:0.99-1000'
        })
      });

      // çŽ°é‡‘æ”¯ä»˜ï¼Œæœ‰ä»·æ ¼
      expect(validate(schema, { payment_type: 'cash', price: 100 }).valid).to.be.true;

      // çŽ°é‡‘æ”¯ä»˜ï¼Œç¼ºå°‘ä»·æ ¼ï¼ˆå¿…å¡«ï¼‰
      const result = validate(schema, { payment_type: 'cash' });
      expect(result.valid).to.be.false;
      expect(result.errors[0].message).to.include('ä»·æ ¼å¿…å¡«');

      // åˆ·å¡æ”¯ä»˜
      expect(validate(schema, { payment_type: 'card', price: 1500 }).valid).to.be.true;
    });

    it('åº”è¯¥æ”¯æŒ dsl.if åµŒå¥— dsl.matchï¼Œéƒ½ä½¿ç”¨ dsl() åŒ…è£¹', () => {
      const schema = dsl({
        enabled: 'boolean',
        payment_type: 'string',
        price: dsl.if('enabled',
          dsl.match('payment_type', {
            'cash': dsl('number:0.99-1000!').label('çŽ°é‡‘ä»·æ ¼'),
            '_default': dsl('number:0.99-1000').label('é»˜è®¤ä»·æ ¼')
          }),
          dsl('number:0.99-500').label('ç¦ç”¨æ—¶ä»·æ ¼')
        )
      });

      // enabled=true, payment_type=cash
      expect(validate(schema, { enabled: true, payment_type: 'cash', price: 100 }).valid).to.be.true;

      // enabled=true, payment_type=cash, ç¼ºå°‘ä»·æ ¼ï¼ˆå¿…å¡«ï¼‰
      expect(validate(schema, { enabled: true, payment_type: 'cash' }).valid).to.be.false;

      // enabled=false
      expect(validate(schema, { enabled: false, price: 100 }).valid).to.be.true;
      expect(validate(schema, { enabled: false, price: 600 }).valid).to.be.false;
    });

    it('åº”è¯¥æ”¯æŒæ··åˆä½¿ç”¨å­—ç¬¦ä¸²å’Œ dsl()', () => {
      const schema = dsl({
        type: 'string',
        value: dsl.match('type', {
          'email': dsl('email!').label('é‚®ç®±åœ°å€').messages({ required: 'é‚®ç®±å¿…å¡«' }),
          'phone': 'string:11!',  // å­—ç¬¦ä¸²å½¢å¼
          '_default': dsl('string').label('å…¶ä»–')
        })
      });

      // email ç±»åž‹
      expect(validate(schema, { type: 'email', value: 'test@example.com' }).valid).to.be.true;
      const emailResult = validate(schema, { type: 'email' });
      expect(emailResult.valid).to.be.false;
      expect(emailResult.errors[0].message).to.include('é‚®ç®±å¿…å¡«');

      // phone ç±»åž‹ï¼ˆå­—ç¬¦ä¸²å½¢å¼ï¼‰
      expect(validate(schema, { type: 'phone', value: '13800138000' }).valid).to.be.true;

      // å…¶ä»–ç±»åž‹
      expect(validate(schema, { type: 'other', value: 'anything' }).valid).to.be.true;
    });
  });

  describe('å¤æ‚åµŒå¥—åœºæ™¯ (v1.0.7)', () => {
    it('åº”è¯¥æ”¯æŒ Match åµŒå¥— Match', () => {
      const schema = dsl({
        category: 'string',
        type: 'string',
        value: dsl.match('category', {
          'contact': dsl.match('type', {
            'email': dsl('email!').label('é‚®ç®±'),
            'phone': dsl('string:11!').label('æ‰‹æœºå·'),
            '_default': 'string'
          }),
          'payment': dsl.match('type', {
            'credit': dsl('integer:1-10000!').label('ä¿¡ç”¨é¢åº¦'),
            'cash': dsl('number:0.01-10000!').label('çŽ°é‡‘é‡‘é¢'),
            '_default': 'number'
          }),
          '_default': 'string'
        })
      });

      // category=contact, type=email
      expect(validate(schema, { category: 'contact', type: 'email', value: 'test@example.com' }).valid).to.be.true;
      expect(validate(schema, { category: 'contact', type: 'email', value: 'invalid' }).valid).to.be.false;

      // category=payment, type=credit
      expect(validate(schema, { category: 'payment', type: 'credit', value: 1000 }).valid).to.be.true;
      expect(validate(schema, { category: 'payment', type: 'credit', value: 1000.5 }).valid).to.be.false; // å¿…é¡»æ˜¯æ•´æ•°
      expect(validate(schema, { category: 'payment', type: 'credit' }).valid).to.be.false; // å¿…å¡«

      // category=payment, type=cash
      expect(validate(schema, { category: 'payment', type: 'cash', value: 99.99 }).valid).to.be.true;
    });

    it('åº”è¯¥æ”¯æŒ Match åµŒå¥— If', () => {
      const schema = dsl({
        user_type: 'string',
        is_vip: 'boolean',
        discount: dsl.match('user_type', {
          'member': dsl.if('is_vip',
            dsl('number:10-50!').label('VIPä¼šå‘˜æŠ˜æ‰£'),
            dsl('number:5-20!').label('æ™®é€šä¼šå‘˜æŠ˜æ‰£')
          ),
          'guest': dsl('number:0-10').label('è®¿å®¢æŠ˜æ‰£'),
          '_default': 'number:0-5'
        })
      });

      // user_type=member, is_vip=true
      expect(validate(schema, { user_type: 'member', is_vip: true, discount: 30 }).valid).to.be.true;
      expect(validate(schema, { user_type: 'member', is_vip: true, discount: 5 }).valid).to.be.false; // ä½ŽäºŽæœ€å°å€¼
      expect(validate(schema, { user_type: 'member', is_vip: true }).valid).to.be.false; // å¿…å¡«

      // user_type=member, is_vip=false
      expect(validate(schema, { user_type: 'member', is_vip: false, discount: 10 }).valid).to.be.true;
      expect(validate(schema, { user_type: 'member', is_vip: false, discount: 25 }).valid).to.be.false; // è¶…è¿‡æœ€å¤§å€¼
      expect(validate(schema, { user_type: 'member', is_vip: false }).valid).to.be.false; // å¿…å¡«

      // user_type=guest
      expect(validate(schema, { user_type: 'guest', discount: 8 }).valid).to.be.true;
      expect(validate(schema, { user_type: 'guest' }).valid).to.be.true; // å¯é€‰
    });

    it('åº”è¯¥æ”¯æŒ If åµŒå¥— Matchï¼ˆç”¨æˆ·æä¾›çš„åœºæ™¯ï¼‰', () => {
      const schema = dsl({
        enabled: 'boolean',
        payment_type: 'string',
        credit_price: dsl.if('enabled',
          dsl.match('payment_type', {
            'credit': dsl('integer:1-10000!')
              .label('credit_price')
              .messages({ required: 'custom.creditPriceRequired' }),
            '_default': 'integer:1-10000'
          }),
          'integer:1-10000'
        )
      });

      // enabled=true, payment_type=credit, æœ‰å€¼
      expect(validate(schema, { enabled: true, payment_type: 'credit', credit_price: 5000 }).valid).to.be.true;

      // enabled=true, payment_type=credit, ç¼ºå°‘å€¼ï¼ˆå¿…å¡«ï¼‰
      const result1 = validate(schema, { enabled: true, payment_type: 'credit' });
      expect(result1.valid).to.be.false;
      // æ³¨æ„ï¼šåµŒå¥— If/Match ä¸­çš„è‡ªå®šä¹‰æ¶ˆæ¯å¯èƒ½ä¸ä¼šå®Œå…¨ä¼ é€’ï¼Œè¿™æ˜¯å·²çŸ¥é™åˆ¶
      expect(result1.errors.some(e => e.path === 'credit_price')).to.be.true;

      // enabled=true, payment_type=otherï¼ˆé»˜è®¤è§„åˆ™ï¼Œå¯é€‰ï¼‰
      expect(validate(schema, { enabled: true, payment_type: 'other', credit_price: 5000 }).valid).to.be.true;
      expect(validate(schema, { enabled: true, payment_type: 'other' }).valid).to.be.true;

      // enabled=falseï¼ˆä½¿ç”¨ else åˆ†æ”¯ï¼Œå¯é€‰ï¼‰
      expect(validate(schema, { enabled: false, credit_price: 5000 }).valid).to.be.true;
      expect(validate(schema, { enabled: false }).valid).to.be.true;
    });

    it('åº”è¯¥æ”¯æŒ If åµŒå¥— If', () => {
      const schema = dsl({
        is_member: 'boolean',
        is_premium: 'boolean',
        price: dsl.if('is_member',
          dsl.if('is_premium',
            dsl('number:100-500!').label('é«˜çº§ä¼šå‘˜ä»·'),
            dsl('number:200-800!').label('æ™®é€šä¼šå‘˜ä»·')
          ),
          dsl('number:500-1000!').label('éžä¼šå‘˜ä»·')
        )
      });

      // is_member=true, is_premium=true
      expect(validate(schema, { is_member: true, is_premium: true, price: 300 }).valid).to.be.true;
      expect(validate(schema, { is_member: true, is_premium: true, price: 600 }).valid).to.be.false; // è¶…è¿‡æœ€å¤§å€¼
      expect(validate(schema, { is_member: true, is_premium: true }).valid).to.be.false; // å¿…å¡«

      // is_member=true, is_premium=false
      expect(validate(schema, { is_member: true, is_premium: false, price: 500 }).valid).to.be.true;
      expect(validate(schema, { is_member: true, is_premium: false, price: 150 }).valid).to.be.false; // ä½ŽäºŽæœ€å°å€¼

      // is_member=false
      expect(validate(schema, { is_member: false, price: 700 }).valid).to.be.true;
      expect(validate(schema, { is_member: false, price: 300 }).valid).to.be.false; // ä½ŽäºŽæœ€å°å€¼
    });

    it('åº”è¯¥æ”¯æŒ _default ä¸­ä½¿ç”¨ Match/If ç»“æž„', () => {
      const schema = dsl({
        tier: 'string',
        is_vip: 'boolean',
        discount: dsl.match('tier', {
          'gold': dsl('number:20-50!').label('é‡‘å¡æŠ˜æ‰£'),
          'silver': dsl('number:10-30!').label('é“¶å¡æŠ˜æ‰£'),
          '_default': dsl.if('is_vip',
            dsl('number:5-15!').label('VIPé»˜è®¤æŠ˜æ‰£'),
            dsl('number:0-10').label('æ™®é€šé»˜è®¤æŠ˜æ‰£')
          )
        })
      });

      // tier=gold
      expect(validate(schema, { tier: 'gold', discount: 30 }).valid).to.be.true;

      // tier=other, is_vip=trueï¼ˆä½¿ç”¨ _default ä¸­çš„ Ifï¼‰
      expect(validate(schema, { tier: 'other', is_vip: true, discount: 10 }).valid).to.be.true;
      expect(validate(schema, { tier: 'other', is_vip: true }).valid).to.be.false; // å¿…å¡«

      // tier=other, is_vip=false
      expect(validate(schema, { tier: 'other', is_vip: false, discount: 5 }).valid).to.be.true;
      expect(validate(schema, { tier: 'other', is_vip: false }).valid).to.be.true; // å¯é€‰
    });

    it('åº”è¯¥æ”¯æŒä¸‰å±‚åµŒå¥—', () => {
      const schema = dsl({
        level1: 'string',
        level2: 'string',
        level3: 'boolean',
        value: dsl.match('level1', {
          'A': dsl.match('level2', {
            'A1': dsl.if('level3',
              dsl('integer:1-100!').label('A-A1-true'),
              dsl('integer:1-50!').label('A-A1-false')
            ),
            'A2': dsl('integer:1-200!').label('A-A2'),
            '_default': 'integer'
          }),
          'B': dsl('integer:1-1000!').label('B'),
          '_default': 'integer'
        })
      });

      // level1=A, level2=A1, level3=true
      expect(validate(schema, { level1: 'A', level2: 'A1', level3: true, value: 80 }).valid).to.be.true;
      expect(validate(schema, { level1: 'A', level2: 'A1', level3: true, value: 120 }).valid).to.be.false;
      expect(validate(schema, { level1: 'A', level2: 'A1', level3: true }).valid).to.be.false; // å¿…å¡«

      // level1=A, level2=A1, level3=false
      expect(validate(schema, { level1: 'A', level2: 'A1', level3: false, value: 40 }).valid).to.be.true;
      expect(validate(schema, { level1: 'A', level2: 'A1', level3: false, value: 60 }).valid).to.be.false;

      // level1=A, level2=A2
      expect(validate(schema, { level1: 'A', level2: 'A2', value: 150 }).valid).to.be.true;

      // level1=B
      expect(validate(schema, { level1: 'B', value: 500 }).valid).to.be.true;
    });
  });

  describe('è¾¹ç•Œå’Œé”™è¯¯å¤„ç† (v1.0.7 è¡¥å……)', () => {
    it('åº”è¯¥å¤„ç†åªæœ‰ _default æ— å…¶ä»–åˆ†æ”¯çš„ match', () => {
      const schema = dsl({
        type: 'string',
        value: dsl.match('type', {
          '_default': dsl('integer:1-100!').label('é»˜è®¤å€¼')
        })
      });

      // ä»»ä½• type å€¼éƒ½åº”è¯¥ä½¿ç”¨ _default è§„åˆ™
      expect(validate(schema, { type: 'any', value: 50 }).valid).to.be.true;
      expect(validate(schema, { type: 'other', value: 150 }).valid).to.be.false; // è¶…å‡ºèŒƒå›´
      expect(validate(schema, { type: 'test' }).valid).to.be.false; // å¿…å¡«
    });

    it('åº”è¯¥å¤„ç†å¤šåˆ†æ”¯ï¼ˆ4+ï¼‰æ··åˆ _default', () => {
      const schema = dsl({
        tier: 'string',
        discount: dsl.match('tier', {
          'bronze': dsl('number:0-5!'),
          'silver': dsl('number:5-10!'),
          'gold': dsl('number:10-20!'),
          'platinum': dsl('number:20-30!'),
          'diamond': dsl('number:30-50!'),
          '_default': dsl('number:0-3')
        })
      });

      // æµ‹è¯•æ¯ä¸ªåˆ†æ”¯
      expect(validate(schema, { tier: 'bronze', discount: 3 }).valid).to.be.true;
      expect(validate(schema, { tier: 'silver', discount: 8 }).valid).to.be.true;
      expect(validate(schema, { tier: 'gold', discount: 15 }).valid).to.be.true;
      expect(validate(schema, { tier: 'platinum', discount: 25 }).valid).to.be.true;
      expect(validate(schema, { tier: 'diamond', discount: 40 }).valid).to.be.true;

      // æµ‹è¯• _default
      expect(validate(schema, { tier: 'other', discount: 2 }).valid).to.be.true;
      expect(validate(schema, { tier: 'unknown' }).valid).to.be.true; // å¯é€‰

      // æµ‹è¯•è¾¹ç•Œè¿è§„
      expect(validate(schema, { tier: 'bronze', discount: 10 }).valid).to.be.false;
      expect(validate(schema, { tier: 'other', discount: 5 }).valid).to.be.false;
    });

    it('åº”è¯¥æ”¯æŒ If çš„ else åˆ†æ”¯ä½¿ç”¨ Matchï¼ˆæ˜Žç¡®æµ‹è¯•ï¼‰', () => {
      const schema = dsl({
        is_premium: 'boolean',
        payment_type: 'string',
        price: dsl.if('is_premium',
          dsl('number:100-500!').label('é«˜çº§ä¼šå‘˜ä»·'),
          dsl.match('payment_type', {
            'cash': dsl('number:200-800!').label('çŽ°é‡‘ä»·'),
            'card': dsl('number:220-850!').label('åˆ·å¡ä»·'),
            '_default': 'number:250-1000'
          })
        )
      });

      // is_premium=trueï¼ˆä½¿ç”¨ then åˆ†æ”¯ï¼‰
      expect(validate(schema, { is_premium: true, price: 300 }).valid).to.be.true;
      expect(validate(schema, { is_premium: true }).valid).to.be.false; // å¿…å¡«

      // is_premium=false, payment_type=cashï¼ˆä½¿ç”¨ else ä¸­çš„ Matchï¼‰
      expect(validate(schema, { is_premium: false, payment_type: 'cash', price: 500 }).valid).to.be.true;
      expect(validate(schema, { is_premium: false, payment_type: 'cash', price: 100 }).valid).to.be.false;
      expect(validate(schema, { is_premium: false, payment_type: 'cash' }).valid).to.be.false; // å¿…å¡«

      // is_premium=false, payment_type=card
      expect(validate(schema, { is_premium: false, payment_type: 'card', price: 600 }).valid).to.be.true;

      // is_premium=false, payment_type=otherï¼ˆä½¿ç”¨ _defaultï¼Œå¯é€‰ï¼‰
      expect(validate(schema, { is_premium: false, payment_type: 'other', price: 500 }).valid).to.be.true;
      expect(validate(schema, { is_premium: false, payment_type: 'other' }).valid).to.be.true;
    });

    it('åº”è¯¥å¤„ç† condition å­—æ®µä¸ºå„ç§å€¼', () => {
      const schema = dsl({
        enabled: 'boolean',
        price: dsl.if('enabled', 'number:100-500', 'number:50-200')
      });

      // æ­£å¸¸æƒ…å†µï¼šenabled=true
      expect(validate(schema, { enabled: true, price: 300 }).valid).to.be.true;
      expect(validate(schema, { enabled: true, price: 50 }).valid).to.be.false; // ä½ŽäºŽ then èŒƒå›´

      // æ­£å¸¸æƒ…å†µï¼šenabled=false
      expect(validate(schema, { enabled: false, price: 100 }).valid).to.be.true;
      expect(validate(schema, { enabled: false, price: 400 }).valid).to.be.false; // è¶…å‡º else èŒƒå›´

      // condition å­—æ®µç¼ºå¤±ï¼ˆJSON Schema if-then-else è¡Œä¸ºï¼šä¸åŒ¹é… const:trueï¼Œè¿›å…¥ elseï¼‰
      // ä½†ç”±äºŽ enabled æœ¬èº«æ²¡æœ‰ requiredï¼Œæ‰€ä»¥å¯ä»¥æŽ¥å—ä»»ä½•åœ¨ price çº¦æŸå†…çš„å€¼
      const result1 = validate(schema, { price: 100 });
      expect(result1.valid).to.be.true; // price åœ¨ else åˆ†æ”¯èŒƒå›´å†…

      // condition å­—æ®µä¸º nullï¼ˆéž booleanï¼Œä½† price å¿…é¡»ç¬¦åˆçº¦æŸï¼‰
      const result2 = validate(schema, { enabled: null, price: 100 });
      // enabled ç±»åž‹ä¸åŒ¹é… booleanï¼Œåº”è¯¥å¤±è´¥
      expect(result2.valid).to.be.false;
    });

    it('åº”è¯¥æ”¯æŒç‰¹æ®Šå­—ç¬¦çš„åˆ†æ”¯é”®å', () => {
      const schema = dsl({
        tier: 'string',
        discount: dsl.match('tier', {
          'VIP-1': dsl('number:10-20!'),
          'VIP 2': dsl('number:20-30!'), // åŒ…å«ç©ºæ ¼
          'VIP_3': dsl('number:30-40!'),
          'ä¼šå‘˜ðŸ‘‘': dsl('number:40-50!'), // Unicode
          '_default': 'number:0-10'
        })
      });

      expect(validate(schema, { tier: 'VIP-1', discount: 15 }).valid).to.be.true;
      expect(validate(schema, { tier: 'VIP 2', discount: 25 }).valid).to.be.true;
      expect(validate(schema, { tier: 'VIP_3', discount: 35 }).valid).to.be.true;
      expect(validate(schema, { tier: 'ä¼šå‘˜ðŸ‘‘', discount: 45 }).valid).to.be.true;
      expect(validate(schema, { tier: 'other', discount: 5 }).valid).to.be.true;
    });

    it('åº”è¯¥åœ¨åµŒå¥—ä¸­æ”¯æŒè‡ªå®šä¹‰æ¶ˆæ¯ï¼ˆå…¨åœºæ™¯æµ‹è¯•ï¼‰', () => {
      // åœºæ™¯ 1: Match åµŒå¥— Match ä¸­çš„è‡ªå®šä¹‰æ¶ˆæ¯
      const schema1 = dsl({
        cat: 'string',
        type: 'string',
        value: dsl.match('cat', {
          'A': dsl.match('type', {
            'email': dsl('email!').label('é‚®ç®±').messages({ required: 'emailRequired' }),
            '_default': 'string'
          }),
          '_default': 'string'
        })
      });

      const result1 = validate(schema1, { cat: 'A', type: 'email' });
      expect(result1.valid).to.be.false;
      expect(result1.errors.some(e => e.path === 'value')).to.be.true;

      // åœºæ™¯ 2: Match åµŒå¥— If ä¸­çš„è‡ªå®šä¹‰æ¶ˆæ¯
      const schema2 = dsl({
        tier: 'string',
        is_vip: 'boolean',
        price: dsl.match('tier', {
          'gold': dsl.if('is_vip',
            dsl('number:100-500!').messages({ required: 'vipPriceRequired' }),
            'number:200-800'
          ),
          '_default': 'number'
        })
      });

      const result2 = validate(schema2, { tier: 'gold', is_vip: true });
      expect(result2.valid).to.be.false;
      expect(result2.errors.some(e => e.path === 'price')).to.be.true;

      // åœºæ™¯ 3: If åµŒå¥— Match ä¸­çš„è‡ªå®šä¹‰æ¶ˆæ¯
      const schema3 = dsl({
        enabled: 'boolean',
        type: 'string',
        value: dsl.if('enabled',
          dsl.match('type', {
            'special': dsl('integer:1-100!').messages({ required: 'specialRequired' }),
            '_default': 'integer'
          }),
          'integer'
        )
      });

      const result3 = validate(schema3, { enabled: true, type: 'special' });
      expect(result3.valid).to.be.false;
      expect(result3.errors.some(e => e.path === 'value')).to.be.true;

      // åœºæ™¯ 4: If åµŒå¥— If ä¸­çš„è‡ªå®šä¹‰æ¶ˆæ¯
      const schema4 = dsl({
        is_member: 'boolean',
        is_premium: 'boolean',
        fee: dsl.if('is_member',
          dsl.if('is_premium',
            dsl('number:50-100!').messages({ required: 'premiumFeeRequired' }),
            'number:100-200'
          ),
          'number:200-500'
        )
      });

      const result4 = validate(schema4, { is_member: true, is_premium: true });
      expect(result4.valid).to.be.false;
      expect(result4.errors.some(e => e.path === 'fee')).to.be.true;
    });

    it('åº”è¯¥åœ¨åµŒå¥—ä¸­æ”¯æŒæžšä¸¾è¯­æ³•', () => {
      const schema = dsl({
        category: 'string',
        status: dsl.match('category', {
          'order': 'pending|processing|completed|cancelled!',
          'user': 'active|inactive|suspended!',
          '_default': 'unknown'
        })
      });

      // order ç±»åˆ«
      expect(validate(schema, { category: 'order', status: 'pending' }).valid).to.be.true;
      expect(validate(schema, { category: 'order', status: 'completed' }).valid).to.be.true;
      expect(validate(schema, { category: 'order', status: 'invalid' }).valid).to.be.false;
      expect(validate(schema, { category: 'order' }).valid).to.be.false; // å¿…å¡«

      // user ç±»åˆ«
      expect(validate(schema, { category: 'user', status: 'active' }).valid).to.be.true;
      expect(validate(schema, { category: 'user', status: 'pending' }).valid).to.be.false; // ä¸åœ¨æžšä¸¾ä¸­

      // é»˜è®¤ç±»åˆ«
      expect(validate(schema, { category: 'other', status: 'unknown' }).valid).to.be.true;
    });

    it('åº”è¯¥æ”¯æŒæ¡ä»¶å­—æ®µæœ¬èº«ä¹Ÿæœ‰éªŒè¯è§„åˆ™', () => {
      const schema = dsl({
        enabled: 'boolean!', // æ¡ä»¶å­—æ®µæœ¬èº«æ˜¯å¿…å¡«çš„
        price: dsl.if('enabled',
          'number:100-500!',
          'number:50-200'
        )
      });

      // æ­£å¸¸æƒ…å†µ
      expect(validate(schema, { enabled: true, price: 300 }).valid).to.be.true;
      expect(validate(schema, { enabled: false, price: 100 }).valid).to.be.true;

      // enabled ç¼ºå¤±ï¼ˆè¿åå¿…å¡«è§„åˆ™ï¼‰
      const result1 = validate(schema, { price: 100 });
      expect(result1.valid).to.be.false;
      expect(result1.errors.some(e => e.path === 'enabled')).to.be.true;

      // enabled ç±»åž‹é”™è¯¯
      expect(validate(schema, { enabled: 'yes', price: 100 }).valid).to.be.false;
    });

    it('åº”è¯¥æ”¯æŒ then å’Œ else åˆ†æ”¯ç±»åž‹ä¸åŒ', () => {
      const schema = dsl({
        mode: 'boolean',  // æ”¹ä¸º booleanï¼Œå› ä¸º dsl.if æ£€æŸ¥ const:true
        type: 'string',
        is_vip: 'boolean',
        value: dsl.if('is_vip',
          // then: ä½¿ç”¨ Match
          dsl.match('type', {
            'A': dsl('integer:1-100!'),
            'B': dsl('integer:100-200!'),
            '_default': 'integer'
          }),
          // else: ä½¿ç”¨ If
          dsl.if('mode',
            dsl('string:5-20!'),
            dsl('string:1-10')
          )
        )
      });

      // is_vip=trueï¼ˆä½¿ç”¨ then: Matchï¼‰
      expect(validate(schema, { is_vip: true, type: 'A', value: 50 }).valid).to.be.true;
      expect(validate(schema, { is_vip: true, type: 'B', value: 150 }).valid).to.be.true;
      expect(validate(schema, { is_vip: true, type: 'C', value: 99 }).valid).to.be.true; // _default

      // is_vip=false, mode=trueï¼ˆä½¿ç”¨ else: If çš„ thenï¼‰
      expect(validate(schema, { is_vip: false, mode: true, value: 'hello world' }).valid).to.be.true;
      expect(validate(schema, { is_vip: false, mode: true, value: 'hi' }).valid).to.be.false; // é•¿åº¦ä¸è¶³
      expect(validate(schema, { is_vip: false, mode: true }).valid).to.be.false; // å¿…å¡«

      // is_vip=false, mode=falseï¼ˆä½¿ç”¨ else: If çš„ elseï¼‰
      expect(validate(schema, { is_vip: false, mode: false, value: 'test' }).valid).to.be.true;
      expect(validate(schema, { is_vip: false, mode: false, value: 'toolongstring' }).valid).to.be.false; // è¶…å‡ºé•¿åº¦
    });
  });

  describe('ä¸‰å±‚åµŒå¥—å…¨åœºæ™¯ (v1.0.7 è¡¥å……)', () => {
    it('åº”è¯¥æ”¯æŒ If åµŒå¥— If åµŒå¥— Match', () => {
      const schema = dsl({
        is_member: 'boolean',
        is_premium: 'boolean',
        payment_type: 'string',
        fee: dsl.if('is_member',
          dsl.if('is_premium',
            // premium member: æ ¹æ®æ”¯ä»˜æ–¹å¼ä¸åŒè´¹ç”¨
            dsl.match('payment_type', {
              'annual': dsl('number:500-1000!').label('å¹´è´¹'),
              'monthly': dsl('number:50-100!').label('æœˆè´¹'),
              '_default': 'number:100-200'
            }),
            // normal member: å›ºå®šè´¹ç”¨
            dsl('number:200-300!')
          ),
          // non-member: å›ºå®šè´¹ç”¨
          dsl('number:300-500!')
        )
      });

      // is_member=true, is_premium=true, payment_type=annual
      expect(validate(schema, { is_member: true, is_premium: true, payment_type: 'annual', fee: 800 }).valid).to.be.true;
      expect(validate(schema, { is_member: true, is_premium: true, payment_type: 'annual', fee: 1500 }).valid).to.be.false;
      expect(validate(schema, { is_member: true, is_premium: true, payment_type: 'annual' }).valid).to.be.false; // å¿…å¡«

      // is_member=true, is_premium=true, payment_type=monthly
      expect(validate(schema, { is_member: true, is_premium: true, payment_type: 'monthly', fee: 80 }).valid).to.be.true;

      // is_member=true, is_premium=false
      expect(validate(schema, { is_member: true, is_premium: false, fee: 250 }).valid).to.be.true;

      // is_member=false
      expect(validate(schema, { is_member: false, fee: 400 }).valid).to.be.true;
    });

    it('åº”è¯¥æ”¯æŒ Match åµŒå¥— If åµŒå¥— Match', () => {
      const schema = dsl({
        region: 'string',
        is_express: 'boolean',
        weight: 'string',
        shipping_fee: dsl.match('region', {
          'domestic': dsl.if('is_express',
            // å›½å†…å¿«é€’: æ ¹æ®é‡é‡è®¡è´¹
            dsl.match('weight', {
              'light': dsl('number:10-20!'),
              'medium': dsl('number:20-40!'),
              'heavy': dsl('number:40-80!'),
              '_default': 'number:5-15'
            }),
            // å›½å†…æ™®é€š: å›ºå®š
            dsl('number:5-10!')
          ),
          'international': dsl.if('is_express',
            // å›½é™…å¿«é€’
            dsl.match('weight', {
              'light': dsl('number:50-100!'),
              'heavy': dsl('number:100-200!'),
              '_default': 'number:30-60'
            }),
            // å›½é™…æ™®é€š
            dsl('number:20-50!')
          ),
          '_default': 'number:0-100'
        })
      });

      // region=domestic, is_express=true, weight=light
      expect(validate(schema, { region: 'domestic', is_express: true, weight: 'light', shipping_fee: 15 }).valid).to.be.true;
      expect(validate(schema, { region: 'domestic', is_express: true, weight: 'light', shipping_fee: 5 }).valid).to.be.false;

      // region=domestic, is_express=false
      expect(validate(schema, { region: 'domestic', is_express: false, shipping_fee: 8 }).valid).to.be.true;

      // region=international, is_express=true, weight=heavy
      expect(validate(schema, { region: 'international', is_express: true, weight: 'heavy', shipping_fee: 150 }).valid).to.be.true;

      // region=international, is_express=false
      expect(validate(schema, { region: 'international', is_express: false, shipping_fee: 30 }).valid).to.be.true;
    });

    it('åº”è¯¥æ”¯æŒ If åµŒå¥— Match åµŒå¥— If', () => {
      const schema = dsl({
        has_coupon: 'boolean',
        user_level: 'string',
        is_first_order: 'boolean',
        final_discount: dsl.if('has_coupon',
          // æœ‰ä¼˜æƒ åˆ¸: æ ¹æ®ç”¨æˆ·ç­‰çº§
          dsl.match('user_level', {
            'vip': dsl.if('is_first_order',
              dsl('number:30-50!').label('VIPé¦–å•æŠ˜æ‰£'),
              dsl('number:20-40!').label('VIPå¸¸è§„æŠ˜æ‰£')
            ),
            'regular': dsl.if('is_first_order',
              dsl('number:15-25!'),
              dsl('number:10-20!')
            ),
            '_default': 'number:5-15'
          }),
          // æ— ä¼˜æƒ åˆ¸: å›ºå®šæŠ˜æ‰£
          dsl('number:0-10')
        )
      });

      // has_coupon=true, user_level=vip, is_first_order=true
      expect(validate(schema, { has_coupon: true, user_level: 'vip', is_first_order: true, final_discount: 40 }).valid).to.be.true;
      expect(validate(schema, { has_coupon: true, user_level: 'vip', is_first_order: true, final_discount: 15 }).valid).to.be.false;
      expect(validate(schema, { has_coupon: true, user_level: 'vip', is_first_order: true }).valid).to.be.false; // å¿…å¡«

      // has_coupon=true, user_level=vip, is_first_order=false
      expect(validate(schema, { has_coupon: true, user_level: 'vip', is_first_order: false, final_discount: 30 }).valid).to.be.true;

      // has_coupon=true, user_level=regular, is_first_order=true
      expect(validate(schema, { has_coupon: true, user_level: 'regular', is_first_order: true, final_discount: 20 }).valid).to.be.true;

      // has_coupon=false
      expect(validate(schema, { has_coupon: false, final_discount: 5 }).valid).to.be.true;
    });
  });
  describe('å‚æ•°éªŒè¯å’Œé”™è¯¯å¤„ç† (v1.0.7 å®Œå–„)', () => {
    it('åº”è¯¥å¤„ç†ç©º map å¯¹è±¡', () => {
      // ç©º map åº”è¯¥å¯¼è‡´æ‰€æœ‰æ•°æ®éƒ½æ— æ³•åŒ¹é…ä»»ä½•è§„åˆ™
      const schema = dsl({
        type: 'string',
        value: dsl.match('type', {})
      });

      // æ²¡æœ‰ä»»ä½•åˆ†æ”¯ï¼Œä¹Ÿæ²¡æœ‰ _defaultï¼Œvalue å­—æ®µæ²¡æœ‰çº¦æŸ
      const result = validate(schema, { type: 'any', value: 'anything' });
      expect(result.valid).to.be.true; // æ²¡æœ‰çº¦æŸ = å…è®¸ä»»ä½•å€¼

      const result2 = validate(schema, { type: 'any', value: 123 });
      expect(result2.valid).to.be.true; // æ²¡æœ‰çº¦æŸ
    });

    it('åº”è¯¥å¤„ç† map ä¸­çš„ null å’Œ undefined åˆ†æ”¯å€¼', () => {
      // æµ‹è¯•åˆ†æ”¯å€¼ä¸ºç‰¹æ®Šå€¼çš„æƒ…å†µ
      const schema1 = dsl({
        type: 'string',
        value: dsl.match('type', {
          'null_case': null,
          'undefined_case': undefined,
          '_default': 'string'
        })
      });

      // null å’Œ undefined åˆ†æ”¯ä¼šè¢«è·³è¿‡ï¼Œä½¿ç”¨ _default
      expect(validate(schema1, { type: 'null_case', value: 'test' }).valid).to.be.true;
      expect(validate(schema1, { type: 'undefined_case', value: 'test' }).valid).to.be.true;
      expect(validate(schema1, { type: 'other', value: 'test' }).valid).to.be.true;
    });

    it('åº”è¯¥éªŒè¯ match çš„å‚æ•°', () => {
      // æµ‹è¯• field å‚æ•° - è¿™äº›éƒ½ä¼šåˆ›å»ºç»“æž„ï¼Œä¸ä¼šæŠ›é”™
      expect(() => dsl.match(null, { 'a': 'string' })).to.not.throw();
      expect(() => dsl.match('', { 'a': 'string' })).to.not.throw();
      expect(() => dsl.match(123, { 'a': 'string' })).to.not.throw();

      // ç©ºå­—æ®µåä¼šæŸ¥æ‰¾ data[''] å­—æ®µ
      const schema1 = dsl({
        type: 'string',
        value: dsl.match('', { 'a': 'string', '_default': 'integer' })
      });

      // data[''] === 'a' æ—¶ï¼Œvalue åº”è¯¥æ˜¯ string
      expect(validate(schema1, { type: 'x', '': 'a', value: 'test' }).valid).to.be.true;
      // data[''] ä¸æ˜¯ 'a' æ—¶ï¼Œä½¿ç”¨ _defaultï¼Œvalue åº”è¯¥æ˜¯ integer
      expect(validate(schema1, { type: 'x', '': 'other', value: 100 }).valid).to.be.true;

      it('åº”è¯¥éªŒè¯ if çš„å‚æ•°', () => {
        // æµ‹è¯• condition å‚æ•°
        expect(() => dsl.if(null, 'string', 'integer')).to.not.throw();
        expect(() => dsl.if('', 'string', 'integer')).to.not.throw();
        expect(() => dsl.if(123, 'string', 'integer')).to.not.throw();

        const schema1 = dsl({
          enabled: 'boolean',
          value: dsl.if('', 'string', 'integer')
        });

        // ç©ºå­—æ®µåä¼šå¯¼è‡´æŸ¥æ‰¾å¤±è´¥
        const result = validate(schema1, { enabled: true, '': true, value: 'test' });
        expect(result.valid).to.be.true;
      });

      it('åº”è¯¥å¤„ç†å¯¹è±¡å’Œæ•°ç»„ä½œä¸ºæ¡ä»¶å€¼', () => {
        const schema = dsl({
          type: 'string',  // type å¿…é¡»æ˜¯ string
          value: dsl.match('type', {
            'complex': 'string:10-50',
            '_default': 'string'
          })
        });

        // æ™®é€šå­—ç¬¦ä¸²åŒ¹é…
        expect(validate(schema, { type: 'complex', value: 'hello world test' }).valid).to.be.true;

        // type ä¸ºå¯¹è±¡æ—¶ï¼Œä¼šå› ä¸º type å­—æ®µç±»åž‹ä¸åŒ¹é…è€Œå¤±è´¥
        const result1 = validate(schema, { type: { nested: 'obj' }, value: 'test' });
        expect(result1.valid).to.be.false;
        expect(result1.errors.some(e => e.path === 'type')).to.be.true;

        // type ä¸ºæ•°ç»„æ—¶åŒç†
        const result2 = validate(schema, { type: ['array'], value: 'test' });
        expect(result2.valid).to.be.false;
        expect(result2.errors.some(e => e.path === 'type')).to.be.true;
        it('åº”è¯¥å¤„ç†åµŒå¥—ä¸­çš„å¾ªçŽ¯ä¾èµ–åœºæ™¯', () => {
          // è™½ç„¶ä¸èƒ½çœŸæ­£æ£€æµ‹å¾ªçŽ¯å¼•ç”¨ï¼ˆéœ€è¦è¿è¡Œæ—¶æ£€æµ‹ï¼‰ï¼Œä½†å¯ä»¥æµ‹è¯•å¤æ‚çš„ç›¸äº’ä¾èµ–
          const schema = dsl({
            level: 'string',
            sub_level: 'string',
            type: 'string',
            value: dsl.match('level', {
              'A': dsl.match('sub_level', {
                'A1': dsl.match('type', {
                  'special': dsl('integer:1-10!'),
                  '_default': 'integer:1-100'
                }),
                '_default': 'integer'
              }),
              '_default': 'string'
            })
          });

          // æ·±å±‚åµŒå¥—ä½†ä¸å¾ªçŽ¯
          expect(validate(schema, { level: 'A', sub_level: 'A1', type: 'special', value: 5 }).valid).to.be.true;
          expect(validate(schema, { level: 'A', sub_level: 'A1', type: 'special', value: 15 }).valid).to.be.false;
        });

        it('åº”è¯¥å¤„ç†åŒä¸€å­—æ®µè¢«å¤šä¸ªè§„åˆ™å¼•ç”¨', () => {
          // æµ‹è¯•å¤šä¸ªæ¡ä»¶éƒ½ä¾èµ–åŒä¸€ä¸ªå­—æ®µ
          const schema = dsl({
            enabled: 'boolean',
            mode: 'string',
            field1: dsl.if('enabled', 'string:5-20', 'string:1-10'),
            field2: dsl.if('enabled', 'integer:100-500', 'integer:1-100'),
            field3: dsl.match('mode', {
              'A': dsl.if('enabled', 'number:10-50', 'number:1-10'),
              '_default': 'number'
            })
          });

          // enabled=true æ—¶
          const result1 = validate(schema, {
            enabled: true,
            mode: 'A',
            field1: 'hello',
            field2: 200,
            field3: 30
          });
          expect(result1.valid).to.be.true;

          // enabled=false æ—¶
          const result2 = validate(schema, {
            enabled: false,
            mode: 'A',
            field1: 'test',
            field2: 50,
            field3: 5
          });
          expect(result2.valid).to.be.true;

          // æ··åˆè¿è§„
          const result3 = validate(schema, {
            enabled: true,
            mode: 'A',
            field1: 'hi', // å¤ªçŸ­
            field2: 200,
            field3: 30
          });
          expect(result3.valid).to.be.false;
        });
      });

      describe('æ·±åº¦åµŒå¥—å’Œé«˜çº§åœºæ™¯ (v1.0.7 å®Œå–„)', () => {
        it('åº”è¯¥æ”¯æŒ4å±‚åµŒå¥—', () => {
          const schema = dsl({
            l1: 'string',
            l2: 'string',
            l3: 'string',
            l4: 'boolean',
            value: dsl.match('l1', {
              'A': dsl.match('l2', {
                'A1': dsl.match('l3', {
                  'A1a': dsl.if('l4',
                    dsl('integer:1-10!'),
                    dsl('integer:11-20!')
                  ),
                  '_default': 'integer:1-100'
                }),
                '_default': 'integer'
              }),
              '_default': 'string'
            })
          });

          // å®Œæ•´4å±‚è·¯å¾„ï¼šA > A1 > A1a > l4=true
          expect(validate(schema, { l1: 'A', l2: 'A1', l3: 'A1a', l4: true, value: 5 }).valid).to.be.true;
          expect(validate(schema, { l1: 'A', l2: 'A1', l3: 'A1a', l4: true, value: 15 }).valid).to.be.false;

          // å®Œæ•´4å±‚è·¯å¾„ï¼šA > A1 > A1a > l4=false
          expect(validate(schema, { l1: 'A', l2: 'A1', l3: 'A1a', l4: false, value: 15 }).valid).to.be.true;
          expect(validate(schema, { l1: 'A', l2: 'A1', l3: 'A1a', l4: false, value: 5 }).valid).to.be.false;

          // 3å±‚è·¯å¾„ï¼šA > A1 > other
          expect(validate(schema, { l1: 'A', l2: 'A1', l3: 'other', value: 50 }).valid).to.be.true;
        });

        it('åº”è¯¥æ”¯æŒå¤§é‡åˆ†æ”¯ï¼ˆ10+ï¼‰', () => {
          const schema = dsl({
            category: 'string',
            discount: dsl.match('category', {
              'cat1': 'number:1-5',
              'cat2': 'number:5-10',
              'cat3': 'number:10-15',
              'cat4': 'number:15-20',
              'cat5': 'number:20-25',
              'cat6': 'number:25-30',
              'cat7': 'number:30-35',
              'cat8': 'number:35-40',
              'cat9': 'number:40-45',
              'cat10': 'number:45-50',
              'cat11': 'number:50-55',
              'cat12': 'number:55-60',
              '_default': 'number:0-100'
            })
          });

          // æµ‹è¯•æ‰€æœ‰åˆ†æ”¯
          expect(validate(schema, { category: 'cat1', discount: 3 }).valid).to.be.true;
          expect(validate(schema, { category: 'cat5', discount: 22 }).valid).to.be.true;
          expect(validate(schema, { category: 'cat12', discount: 57 }).valid).to.be.true;
          expect(validate(schema, { category: 'other', discount: 75 }).valid).to.be.true;

          // æµ‹è¯•è¾¹ç•Œè¿è§„
          expect(validate(schema, { category: 'cat1', discount: 6 }).valid).to.be.false;
          expect(validate(schema, { category: 'cat12', discount: 50 }).valid).to.be.false;
        });

        it('åº”è¯¥åœ¨åµŒå¥—ä¸­æ”¯æŒ .custom() éªŒè¯å™¨', () => {
          const schema = dsl({
            type: 'string',
            value: dsl.match('type', {
              'email': dsl('string!')
                .custom((value) => {
                  if (!value.includes('@')) {
                    return { valid: false, message: 'å¿…é¡»åŒ…å«@ç¬¦å·' };
                  }
                  return { valid: true };
                }),
              'phone': dsl('string:11!')
                .custom((value) => {
                  if (!/^1[3-9]\d{9}$/.test(value)) {
                    return { valid: false, message: 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®' };
                  }
                  return { valid: true };
                }),
              '_default': 'string'
            })
          });

          // email ç±»åž‹ + custom éªŒè¯
          expect(validate(schema, { type: 'email', value: 'test@example.com' }).valid).to.be.true;
          // æ³¨æ„ï¼šcustom éªŒè¯å™¨åœ¨åµŒå¥— Match/If ä¸­å¯èƒ½ä¸ä¼šä¼ é€’ï¼Œè¿™æ˜¯å·²çŸ¥é™åˆ¶
          // ä½†åŸºç¡€çš„å­—ç¬¦ä¸²éªŒè¯ï¼ˆå¿…å¡«ï¼‰ä»ç„¶æœ‰æ•ˆ
          expect(result1.valid).to.be.false;

          // phone ç±»åž‹ + custom éªŒè¯ - é•¿åº¦éªŒè¯ä¼šç”Ÿæ•ˆ
          expect(validate(schema, { type: 'phone', value: '13800138000' }).valid).to.be.true;
          const result2 = validate(schema, { type: 'phone', value: '123456789' }); // é•¿åº¦ä¸è¶³
          expect(result2.valid).to.be.false
          expect(result2.errors[0].message).to.include('æ ¼å¼');
        });

        it('åº”è¯¥åœ¨åµŒå¥— If ä¸­æ”¯æŒ .custom() éªŒè¯å™¨', () => {
          const schema = dsl({
            is_vip: 'boolean',
            price: dsl.if('is_vip',
              dsl('number:100-500!')
                .custom((value) => {
                  if (value % 10 !== 0) {
                    return { valid: false, message: 'VIPä»·æ ¼å¿…é¡»æ˜¯10çš„å€æ•°' };
                  }
                  return { valid: true };
                }),
              dsl('number:50-300!')
                .custom((value) => {
                  if (value % 5 !== 0) {
                    return { valid: false, message: 'æ™®é€šä»·æ ¼å¿…é¡»æ˜¯5çš„å€æ•°' };
                  }
                  return { valid: true };
                })
            )
          });

          // VIP: èŒƒå›´éªŒè¯ç”Ÿæ•ˆ
          expect(validate(schema, { is_vip: true, price: 200 }).valid).to.be.true;
          const result1 = validate(schema, { is_vip: true, price: 600 }); // è¶…å‡ºèŒƒå›´
          expect(result1.valid).to.be.false;

          // æ™®é€šç”¨æˆ·: èŒƒå›´éªŒè¯ç”Ÿæ•ˆ
          expect(validate(schema, { is_vip: false, price: 100 }).valid).to.be.true;
          const result2 = validate(schema, { is_vip: false, price: 400 }); // è¶…å‡ºèŒƒå›´
          expect(result2.valid).to.be.false;

          // æ³¨æ„ï¼šcustom éªŒè¯å™¨åœ¨åµŒå¥—ä¸­å¯èƒ½ä¸ä¼šå®Œå…¨ä¼ é€’ï¼ˆå·²çŸ¥é™åˆ¶ï¼‰
          // ä½†åŸºç¡€çš„èŒƒå›´éªŒè¯ä»ç„¶æœ‰æ•ˆ
        });

    it('åº”è¯¥æ”¯æŒåµŒå¥—ä¸­çš„å¤æ‚å¯¹è±¡è§„åˆ™', () => {
      // æ³¨æ„ï¼šdsl.match çš„ field å‚æ•°ä¸æ”¯æŒåµŒå¥—è·¯å¾„ï¼ˆå¦‚ 'config.engine'ï¼‰
      // éœ€è¦ä½¿ç”¨å¹³é“ºçš„å­—æ®µç»“æž„
      const schema = dsl({
        type: 'string',
        engine: 'string',  // å¹³é“ºå­—æ®µ
        config: dsl.match('type', {
          'database': dsl.match('engine', {
            'mysql': {
              host: 'string!',
              port: 'integer:1-65535!',
              database: 'string!'
            },
            'mongodb': {
              uri: 'string!',
              database: 'string!'
            },
            '_default': {
              connection_string: 'string!'
            }
          }),
          'api': {
            url: 'url!',
            token: 'string:32-128!',
            timeout: 'integer:1000-30000'
          },
          '_default': 'object'
        })
      });

      // database > mysql
      expect(validate(schema, {
        type: 'database',
        engine: 'mysql',
        config: {
          host: 'localhost',
          port: 3306,
          database: 'test_db'
        }
      }).valid).to.be.true;

      // database > mongodb
      expect(validate(schema, {
        type: 'database',
        engine: 'mongodb',
        config: {
          uri: 'mongodb://localhost:27017',
          database: 'test_db'
        }
      }).valid).to.be.true;

      // api
      expect(validate(schema, {
        type: 'api',
        config: {
          url: 'https://api.example.com',
          token: 'a'.repeat(32),
          timeout: 5000
        }
      }).valid).to.be.true;
    });

    it('åº”è¯¥æ”¯æŒæ··åˆåµŒå¥—ï¼šMatchä¸­Ifï¼ŒIfä¸­Matchï¼Œå†åµŒå¥—å¯¹è±¡', () => {
        const schema = dsl({
          region: 'string',
          user_type: 'string',
          has_subscription: 'boolean',
          service_config: dsl.match('region', {
            'cn': dsl.if('has_subscription',
              dsl.match('user_type', {
                'premium': {
                  api_calls: 'integer:10000-100000!',
                  storage: 'integer:100-1000!',
                  support: 'string'
                },
                'basic': {
                  api_calls: 'integer:1000-10000!',
                  storage: 'integer:10-100!',
                  support: 'string'
                },
                '_default': {
                  api_calls: 'integer:100-1000',
                  storage: 'integer:1-10'
                }
              }),
              {
                api_calls: 'integer:10-100',
                storage: 'integer:1-5'
              }
            ),
            'us': dsl.if('has_subscription',
              {
                api_calls: 'integer:20000-200000!',
                storage: 'integer:200-2000!'
              },
              {
                api_calls: 'integer:100-1000',
                storage: 'integer:5-50'
              }
            ),
            '_default': {
              api_calls: 'integer:50-500',
              storage: 'integer:1-10'
            }
          })
        });

        // cn + has_subscription + premium
        expect(validate(schema, {
          region: 'cn',
          user_type: 'premium',
          has_subscription: true,
          service_config: {
            api_calls: 50000,
            storage: 500,
            support: '24/7'
          }
        }).valid).to.be.true;

        // cn + has_subscription + basic
        expect(validate(schema, {
          region: 'cn',
          user_type: 'basic',
          has_subscription: true,
          service_config: {
            api_calls: 5000,
            storage: 50
          }
        }).valid).to.be.true;

        // cn + no subscription
        expect(validate(schema, {
          region: 'cn',
          has_subscription: false,
          service_config: {
            api_calls: 50,
            storage: 3
          }
        }).valid).to.be.true;

        // us + has_subscription
        expect(validate(schema, {
          region: 'us',
          has_subscription: true,
          service_config: {
            api_calls: 100000,
            storage: 1000
          }
        }).valid).to.be.true;
      });
    });

