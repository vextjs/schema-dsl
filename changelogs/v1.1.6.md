# v1.1.6 - Bugä¿®å¤ä¸æµ‹è¯•å¢å¼º

**å‘å¸ƒæ—¥æœŸ**: 2026-01-23

## ğŸ› Bug ä¿®å¤

### ErrorFormatter - å‚æ•°æ˜ å°„å®Œæ•´æ€§ä¿®å¤

ä¿®å¤äº† `ErrorFormatter` ä¸­ ajv é”™è¯¯å‚æ•°æ˜ å°„ä¸å®Œæ•´çš„é—®é¢˜ï¼Œ**æ”¯æŒæ‰€æœ‰5ç§å†…ç½®è¯­è¨€**ï¼ˆen-US, zh-CN, es-ES, fr-FR, ja-JPï¼‰ï¼Œç¡®ä¿æ‰€æœ‰æ¨¡æ¿å˜é‡éƒ½èƒ½æ­£ç¡®æ›¿æ¢ã€‚

#### 1. **ä¿®å¤ enum é”™è¯¯æ¶ˆæ¯ä¸­çš„æ¨¡æ¿å˜é‡æœªæ›¿æ¢é—®é¢˜** ğŸ”´

**é—®é¢˜æè¿°**:
- å½“ enum éªŒè¯å¤±è´¥æ—¶ï¼Œé”™è¯¯æ¶ˆæ¯æ˜¾ç¤º `"must be one of: {{#valids}}"` 
- æ¨¡æ¿å˜é‡ `{{#valids}}` æ²¡æœ‰è¢«å®é™…çš„æšä¸¾å€¼æ›¿æ¢

**æ ¹æœ¬åŸå› **:
- ajv è¿”å›çš„ enum é”™è¯¯å‚æ•°å­—æ®µåæ˜¯ `allowedValues`
- é”™è¯¯æ¶ˆæ¯æ¨¡æ¿ä½¿ç”¨çš„æ˜¯ `{{#valids}}` å’Œ `{{#allowed}}`
- ErrorFormatter æ²¡æœ‰å°† `allowedValues` æ˜ å°„åˆ°è¿™ä¸¤ä¸ªå˜é‡

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// lib/core/ErrorFormatter.js
const interpolateData = {
  ...err.params,
  // ... å…¶ä»–æ˜ å°„
  // âœ… ä¿®å¤ enum é”™è¯¯ï¼šå°† allowedValues æ˜ å°„ä¸º valids å’Œ allowed
  valids: err.params && err.params.allowedValues ? err.params.allowedValues.join(', ') : undefined,
  allowed: err.params && err.params.allowedValues ? err.params.allowedValues.join(', ') : undefined
};
```

**ä¿®å¤æ•ˆæœ**:
- ä¿®å¤å‰: `"plan_type must be one of: {{#valids}}"`
- ä¿®å¤å: `"plan_type must be one of: pro, basic, free"`

#### 2. **ä¿®å¤ additionalProperties é”™è¯¯æ¶ˆæ¯å‚æ•°æ˜ å°„**

**é—®é¢˜æè¿°**:
- additionalProperties é”™è¯¯æ¶ˆæ¯åº”è¯¥æ˜¾ç¤ºæœªçŸ¥å±æ€§åï¼Œä½†å®é™…æ²¡æœ‰

**æ ¹æœ¬åŸå› **:
- ajv è¿”å›çš„å‚æ•°å­—æ®µåæ˜¯ `additionalProperty`
- æ¨¡æ¿ä½¿ç”¨çš„æ˜¯ `{{#key}}`
- ErrorFormatter æ²¡æœ‰æ˜ å°„ï¼Œä¸”è¯­è¨€åŒ…ä¸­ç¼ºå°‘ additionalProperties çš„æ¶ˆæ¯æ¨¡æ¿

**ä¿®å¤æ–¹æ¡ˆ**:
1. åœ¨ ErrorFormatter ä¸­æ·»åŠ å‚æ•°æ˜ å°„:
```javascript
// âœ… ä¿®å¤ additionalProperties é”™è¯¯ï¼šå°† additionalProperty æ˜ å°„ä¸º key
key: err.params && err.params.additionalProperty ? err.params.additionalProperty : undefined
```

2. åœ¨**æ‰€æœ‰5ç§å†…ç½®è¯­è¨€åŒ…**ä¸­æ·»åŠ æ¶ˆæ¯æ¨¡æ¿:
```javascript
// lib/locales/en-US.js (è‹±æ–‡)
'additionalProperties': '{{#label}} must NOT have additional properties: {{#key}}'

// lib/locales/zh-CN.js (ä¸­æ–‡)
'additionalProperties': '{{#label}}ä¸å…è®¸æœ‰é¢å¤–å±æ€§: {{#key}}'

// lib/locales/es-ES.js (è¥¿ç­ç‰™è¯­)
'additionalProperties': '{{#label}} NO debe tener propiedades adicionales: {{#key}}'

// lib/locales/fr-FR.js (æ³•è¯­)
'additionalProperties': '{{#label}} NE doit PAS avoir de propriÃ©tÃ©s supplÃ©mentaires : {{#key}}'

// lib/locales/ja-JP.js (æ—¥è¯­)
'additionalProperties': '{{#label}}ã«è¿½åŠ ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å«ã‚ã¦ã¯ã„ã‘ã¾ã›ã‚“: {{#key}}'
```

**ä¿®å¤æ•ˆæœ**:
- ä¿®å¤å‰: `"must NOT have additional properties"`
- ä¿®å¤å: `"value must NOT have additional properties: email"`

## âœ… æµ‹è¯•å¢å¼º

### æ–°å¢é”™è¯¯æ¶ˆæ¯æ’å€¼å®Œæ•´æ€§æµ‹è¯•

åˆ›å»ºäº†å®Œæ•´çš„æµ‹è¯•å¥—ä»¶ï¼Œå…¨é¢éªŒè¯æ‰€æœ‰é”™è¯¯ç±»å‹å’Œæ‰€æœ‰è¯­è¨€çš„å‚æ•°æ˜ å°„ï¼š

#### 1. åŸºç¡€å‚æ•°æ˜ å°„æµ‹è¯• (`test/unit/error-message-interpolation.test.js`)
**æµ‹è¯•è¦†ç›–**:
- âœ… enum é”™è¯¯æ¶ˆæ¯ï¼ˆå¿…å¡«/å¯é€‰/æ•°å­—æšä¸¾/ä¸­æ–‡ï¼‰
- âœ… additionalProperties é”™è¯¯æ¶ˆæ¯
- âœ… required é”™è¯¯æ¶ˆæ¯
- âœ… minLength/maxLength é”™è¯¯æ¶ˆæ¯
- âœ… minimum/maximum é”™è¯¯æ¶ˆæ¯
- âœ… type é”™è¯¯æ¶ˆæ¯
- âœ… minItems/maxItems é”™è¯¯æ¶ˆæ¯
- âœ… format é”™è¯¯æ¶ˆæ¯
- âœ… å¤šè¯­è¨€æ”¯æŒï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰

#### 2. å¤šè¯­è¨€å®Œæ•´æ€§æµ‹è¯• (`test/unit/multi-language-error-messages.test.js`)
**æµ‹è¯•è¦†ç›–**:
- âœ… enum é”™è¯¯æ¶ˆæ¯ - æ‰€æœ‰5ç§è¯­è¨€ï¼ˆen-US, zh-CN, es-ES, fr-FR, ja-JPï¼‰
- âœ… additionalProperties é”™è¯¯æ¶ˆæ¯ - æ‰€æœ‰5ç§è¯­è¨€
- âœ… éªŒè¯æ¯ç§è¯­è¨€çš„æ¨¡æ¿å˜é‡éƒ½æ­£ç¡®æ›¿æ¢
- âœ… éªŒè¯æ¯ç§è¯­è¨€çš„é”™è¯¯æ¶ˆæ¯éƒ½åŒ…å«å¿…è¦ä¿¡æ¯

#### 3. ä¸‰è½®æ·±åº¦æ£€æŸ¥ (`test-three-rounds-check.js`)
**ç¬¬ä¸€è½® - æ‰€æœ‰ajvé”™è¯¯ç±»å‹éªŒè¯**ï¼ˆ16ä¸ªé”™è¯¯ç±»å‹ï¼‰:
- âœ… required, minLength, maxLength, minimum, maximum
- âœ… enum, pattern, format, type
- âœ… minItems, maxItems, minProperties, maxProperties
- âœ… additionalProperties, uniqueItems, const

**ç¬¬äºŒè½® - è¾¹ç•Œæƒ…å†µå’Œæç«¯å€¼**ï¼ˆ10ä¸ªæµ‹è¯•ï¼‰:
- âœ… ç©ºå­—ç¬¦ä¸²æšä¸¾ã€è¶…é•¿æšä¸¾åˆ—è¡¨ï¼ˆ100ä¸ªå€¼ï¼‰
- âœ… æ•°å­—0ä½œä¸ºæšä¸¾å€¼ã€nullä½œä¸ºæšä¸¾å€¼
- âœ… undefinedä½œä¸ºæ•°æ®ã€éå¸¸æ·±çš„åµŒå¥—å¯¹è±¡
- âœ… åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„å±æ€§åï¼ˆ`user-name`, `user.email`ï¼‰
- âœ… æå¤§æ•°å€¼ï¼ˆMAX_SAFE_INTEGERï¼‰ã€æå°æ•°å€¼ï¼ˆMIN_SAFE_INTEGERï¼‰
- âœ… Infinityå€¼

**ç¬¬ä¸‰è½® - å¤šè¯­è¨€ä¸€è‡´æ€§**ï¼ˆ4ä¸ªåœºæ™¯ Ã— 5ç§è¯­è¨€ = 20ä¸ªæµ‹è¯•ï¼‰:
- âœ… enumé”™è¯¯ - æ‰€æœ‰è¯­è¨€æ­£ç¡®
- âœ… additionalPropertiesé”™è¯¯ - æ‰€æœ‰è¯­è¨€æ­£ç¡®
- âœ… requiredé”™è¯¯ - æ‰€æœ‰è¯­è¨€æ­£ç¡®
- âœ… typeé”™è¯¯ - æ‰€æœ‰è¯­è¨€æ­£ç¡®
- âœ… minItems/maxItems é”™è¯¯æ¶ˆæ¯
- âœ… format é”™è¯¯æ¶ˆæ¯
- âœ… å¤šè¯­è¨€æ”¯æŒï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰

**æµ‹è¯•åŸåˆ™**:
- ä¸ä»…éªŒè¯éªŒè¯ç»“æœï¼ˆvalid: true/falseï¼‰
- è¿˜éªŒè¯é”™è¯¯æ¶ˆæ¯å†…å®¹æ˜¯å¦æ­£ç¡®
- ç¡®ä¿æ‰€æœ‰æ¨¡æ¿å˜é‡éƒ½è¢«æ­£ç¡®æ›¿æ¢
- ç¡®ä¿ä¸åŒ…å«æœªæ›¿æ¢çš„æ¨¡æ¿è¯­æ³•ï¼ˆå¦‚ `{{#xxx}}`ï¼‰

## ğŸ” ä¸ºä»€ä¹ˆä¹‹å‰çš„å•å…ƒæµ‹è¯•æ²¡æœ‰æµ‹è¯•åˆ°ï¼Ÿ

### é—®é¢˜åˆ†æ

1. **ç°æœ‰æµ‹è¯•åªéªŒè¯éªŒè¯ç»“æœï¼Œä¸éªŒè¯é”™è¯¯æ¶ˆæ¯**:
   - ç°æœ‰çš„ enum æµ‹è¯•ï¼ˆ`test/unit/enum.test.js`ï¼‰åªæ£€æŸ¥ `result.valid === false`
   - æ²¡æœ‰æ£€æŸ¥ `error.message` çš„å…·ä½“å†…å®¹
   - å› æ­¤å³ä½¿é”™è¯¯æ¶ˆæ¯åŒ…å«æœªæ›¿æ¢çš„æ¨¡æ¿å˜é‡ï¼Œæµ‹è¯•ä¹Ÿä¼šé€šè¿‡

2. **ç¼ºå°‘ä¸“é—¨çš„é”™è¯¯æ¶ˆæ¯æ ¼å¼åŒ–æµ‹è¯•**:
   - ErrorFormatter çš„æµ‹è¯•è¦†ç›–ä¸å¤Ÿå…¨é¢
   - æ²¡æœ‰éªŒè¯æ‰€æœ‰ ajv é”™è¯¯å‚æ•°ç±»å‹çš„æ˜ å°„

### æ”¹è¿›æªæ–½

æ–°å¢çš„æµ‹è¯•ç¡®ä¿ï¼š
- âœ… æ‰€æœ‰é”™è¯¯æ¶ˆæ¯éƒ½æ£€æŸ¥å®é™…å†…å®¹
- âœ… éªŒè¯æšä¸¾å€¼æ˜¯å¦æ­£ç¡®æ˜¾ç¤º
- âœ… éªŒè¯æ¨¡æ¿å˜é‡æ˜¯å¦å®Œå…¨æ›¿æ¢
- âœ… è¦†ç›–æ‰€æœ‰ ajv é”™è¯¯ç±»å‹çš„å‚æ•°æ˜ å°„

## ğŸ“ å˜æ›´æ–‡ä»¶

### æ ¸å¿ƒä¿®å¤ (6ä¸ªæ–‡ä»¶)
- `lib/core/ErrorFormatter.js` - æ·»åŠ  enum å’Œ additionalProperties å‚æ•°æ˜ å°„
- `lib/locales/en-US.js` - æ·»åŠ  additionalProperties é”™è¯¯æ¶ˆæ¯æ¨¡æ¿
- `lib/locales/zh-CN.js` - æ·»åŠ  additionalProperties é”™è¯¯æ¶ˆæ¯æ¨¡æ¿
- `lib/locales/es-ES.js` - æ·»åŠ  additionalProperties é”™è¯¯æ¶ˆæ¯æ¨¡æ¿ ğŸ†•
- `lib/locales/fr-FR.js` - æ·»åŠ  additionalProperties é”™è¯¯æ¶ˆæ¯æ¨¡æ¿ ğŸ†•
- `lib/locales/ja-JP.js` - æ·»åŠ  additionalProperties é”™è¯¯æ¶ˆæ¯æ¨¡æ¿ ğŸ†•

### æµ‹è¯•å¢å¼º (3ä¸ªæ–‡ä»¶)
- `test/unit/error-message-interpolation.test.js` - åŸºç¡€å‚æ•°æ˜ å°„æµ‹è¯•ï¼ˆ14ä¸ªæµ‹è¯•ï¼‰
- `test/unit/multi-language-error-messages.test.js` - å¤šè¯­è¨€å®Œæ•´æ€§æµ‹è¯•ï¼ˆ10ä¸ªæµ‹è¯•ï¼‰ğŸ†•
- `test-three-rounds-check.js` - ä¸‰è½®æ·±åº¦æ£€æŸ¥è„šæœ¬ï¼ˆ30ä¸ªæ£€æŸ¥é¡¹ï¼‰ğŸ†•

## ğŸ”„ å‘åå…¼å®¹æ€§

âœ… **å®Œå…¨å‘åå…¼å®¹**
- åªæ˜¯ä¿®å¤äº†é”™è¯¯æ¶ˆæ¯æ˜¾ç¤ºçš„Bugï¼Œä¸å½±å“éªŒè¯é€»è¾‘
- æ‰€æœ‰ç°æœ‰APIä¿æŒä¸å˜
- æ‰€æœ‰ç°æœ‰æµ‹è¯•ï¼ˆ967ä¸ªï¼‰å…¨éƒ¨é€šè¿‡
- æ–°å¢10ä¸ªå¤šè¯­è¨€æµ‹è¯•ï¼Œæ€»è®¡977ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡

## ğŸ“Š æµ‹è¯•è¦†ç›–

- **åŸæµ‹è¯•æ•°**: 967ä¸ª
- **æ–°å¢æµ‹è¯•**: 10ä¸ªï¼ˆå¤šè¯­è¨€å®Œæ•´æ€§æµ‹è¯•ï¼‰
- **æ€»æµ‹è¯•æ•°**: 977ä¸ª
- **é€šè¿‡ç‡**: 100%
- **æ·±åº¦æ£€æŸ¥**: 30ä¸ªæ£€æŸ¥é¡¹å…¨éƒ¨é€šè¿‡

## ğŸ¯ å½±å“èŒƒå›´

### å—ç›Šåœºæ™¯
1. æ‰€æœ‰ä½¿ç”¨ enum éªŒè¯çš„åœºæ™¯
2. ä½¿ç”¨ additionalProperties: false çš„åœºæ™¯
3. éœ€è¦å‡†ç¡®é”™è¯¯æ¶ˆæ¯çš„åœºæ™¯
4. å¤šè¯­è¨€å›½é™…åŒ–åœºæ™¯

### ç”¨æˆ·ä½“éªŒæ”¹è¿›
- âœ… é”™è¯¯æ¶ˆæ¯æ›´æ¸…æ™°æ˜ç¡®
- âœ… æšä¸¾å€¼æ­£ç¡®æ˜¾ç¤ºï¼Œç”¨æˆ·çŸ¥é“å¯é€‰å€¼
- âœ… é¢å¤–å±æ€§åæ­£ç¡®æ˜¾ç¤ºï¼Œç”¨æˆ·çŸ¥é“å“ªä¸ªå­—æ®µä¸è¯¥æäº¤
- âœ… å¤šè¯­è¨€é”™è¯¯æ¶ˆæ¯æ›´å‡†ç¡®

## ğŸ”— ç›¸å…³Issue

æ— ï¼ˆå†…éƒ¨å‘ç°çš„Bugï¼‰

## ğŸ“š æ–‡æ¡£æ›´æ–°

æ— éœ€æ–‡æ¡£æ›´æ–°ï¼ˆåªæ˜¯Bugä¿®å¤ï¼‰

---

**å‡çº§å»ºè®®**: 
- å»ºè®®æ‰€æœ‰ç”¨æˆ·å‡çº§åˆ° v1.1.6
- æ— éœ€ä¿®æ”¹ä»»ä½•ä»£ç 
- ä»…éœ€æ‰§è¡Œ `npm update schema-dsl`
