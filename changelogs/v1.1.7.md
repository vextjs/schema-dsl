# v1.1.7 - é”™è¯¯æ¶ˆæ¯è·¯å¾„æ˜¾ç¤ºä¼˜åŒ–

**å‘å¸ƒæ—¥æœŸ**: 2026-01-27  
**ç±»å‹**: Bugä¿®å¤ ğŸ›  
**é‡è¦æ€§**: â­â­â­â­

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°ä¿®å¤äº†åµŒå¥—å¯¹è±¡é”™è¯¯æ¶ˆæ¯ä¸­æ˜¾ç¤ºå®Œæ•´è·¯å¾„çš„é—®é¢˜ï¼Œæå‡äº†é”™è¯¯æ¶ˆæ¯çš„å¯è¯»æ€§å’Œå‹å¥½æ€§ã€‚

**æ ¸å¿ƒæ”¹è¿›**ï¼š
- é”™è¯¯æ¶ˆæ¯ (`message`) ç°åœ¨åªæ˜¾ç¤ºå­—æ®µåï¼Œè€Œä¸æ˜¯å®Œæ•´è·¯å¾„
- é”™è¯¯è·¯å¾„ (`path`) ä¿ç•™å®Œæ•´è·¯å¾„ç”¨äºå®šä½
- ç»Ÿä¸€æ‰€æœ‰é”™è¯¯ç±»å‹çš„å¤„ç†é€»è¾‘

---

## ğŸ› é—®é¢˜æè¿°

### ä¿®å¤å‰

åµŒå¥—å¯¹è±¡çš„é”™è¯¯æ¶ˆæ¯åŒ…å«å®Œæ•´è·¯å¾„ï¼Œå†—é•¿ä¸”ä¸å‹å¥½ï¼š

```javascript
{
  path: 'user/profile/age',
  message: 'user/profile/age should be number, got string',  // âŒ åŒ…å«å®Œæ•´è·¯å¾„
  keyword: 'type'
}
```

### ä¿®å¤å

é”™è¯¯æ¶ˆæ¯åªæ˜¾ç¤ºå­—æ®µåï¼Œæ›´åŠ ç®€æ´å‹å¥½ï¼š

```javascript
{
  path: 'user/profile/age',        // âœ… ä¿ç•™å®Œæ•´è·¯å¾„ç”¨äºå®šä½
  message: 'age should be number, got string',  // âœ… åªæ˜¾ç¤ºå­—æ®µå
  keyword: 'type'
}
```

---

## ğŸ”§ ä¿®å¤å†…å®¹

### 1. ä¿®å¤èŒƒå›´

ä¿®æ”¹äº† `lib/core/ErrorFormatter.js`ï¼Œä¼˜åŒ–äº†æ‰€æœ‰é”™è¯¯ç±»å‹çš„ label ç”Ÿæˆé€»è¾‘ï¼š

**ä¿®å¤çš„é”™è¯¯ç±»å‹**ï¼ˆå…¨è¦†ç›–ï¼‰ï¼š
- âœ… `required` - ç¼ºå°‘å¿…å¡«å­—æ®µ
- âœ… `type` - ç±»å‹ä¸åŒ¹é…
- âœ… `minLength`/`maxLength` - å­—ç¬¦ä¸²é•¿åº¦é™åˆ¶
- âœ… `pattern`/`format` - æ ¼å¼éªŒè¯
- âœ… `enum` - æšä¸¾éªŒè¯
- âœ… `minimum`/`maximum` - æ•°å€¼èŒƒå›´
- âœ… `minItems`/`maxItems` - æ•°ç»„é•¿åº¦
- âœ… `additionalProperties` - é¢å¤–å±æ€§
- âœ… æ‰€æœ‰å…¶ä»– ajv é”™è¯¯ç±»å‹

### 2. æŠ€æœ¯å®ç°

#### ä¿®å¤1ï¼šæ­£ç¡®å¤„ç† required é”™è¯¯çš„å­—æ®µè·¯å¾„ï¼ˆç¬¬139-158è¡Œï¼‰

```javascript
let fieldName;
if (keyword === 'required' && err.params && err.params.missingProperty) {
  // required é”™è¯¯ï¼šå­—æ®µååº”è¯¥æ˜¯çˆ¶è·¯å¾„ + ç¼ºå¤±å±æ€§
  const parentPath = instancePath.replace(/^\//, '');
  const missingProp = err.params.missingProperty;
  fieldName = parentPath ? `${parentPath}/${missingProp}` : missingProp;
} else {
  // å…¶ä»–é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨ instancePath
  fieldName = instancePath.replace(/^\//, '') || 'value';
}
```

#### ä¿®å¤2ï¼šç»Ÿä¸€ä¼˜åŒ–æ‰€æœ‰é”™è¯¯ç±»å‹çš„ label ç”Ÿæˆï¼ˆç¬¬160-185è¡Œï¼‰

```javascript
let labelKey;
if (keyword === 'required' && err.params && err.params.missingProperty) {
  // required é”™è¯¯ï¼šä½¿ç”¨ missingPropertyï¼ˆç¼ºå¤±çš„å­—æ®µåï¼‰
  labelKey = err.params.missingProperty;
} else {
  // å…¶ä»–é”™è¯¯ï¼šä»å®Œæ•´è·¯å¾„ä¸­æå–æœ€åä¸€çº§å­—æ®µå
  // ä¾‹å¦‚: "user/profile/age" -> "age"
  //      "user/scores/1" -> "1"
  const parts = fieldName.split('/');
  labelKey = parts[parts.length - 1];
}
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

| åœºæ™¯ | pathï¼ˆå®šä½ï¼‰ | messageï¼ˆä¿®å¤å‰ï¼‰ | messageï¼ˆä¿®å¤åï¼‰ |
|------|-------------|------------------|------------------|
| é¡¶å±‚å¿…å¡« | `name` | `name is required` | `name is required` âœ… |
| åµŒå¥—å¿…å¡« | `project/project_id` | `project is required` âŒ | `project_id is required` âœ… |
| ç±»å‹é”™è¯¯ | `user/profile/age` | `user/profile/age should be number` âŒ | `age should be number` âœ… |
| é•¿åº¦é”™è¯¯ | `user/profile/username` | `user/profile/username must be at least 3` âŒ | `username must be at least 3` âœ… |
| æ ¼å¼é”™è¯¯ | `user/contact/email` | `user/contact/email must be valid` âŒ | `email must be valid` âœ… |
| æšä¸¾é”™è¯¯ | `user/settings/theme` | `user/settings/theme must be one of: ...` âŒ | `theme must be one of: ...` âœ… |
| æ•°ç»„å…ƒç´  | `user/scores/1` | `user/scores/1 should be number` âŒ | `1 should be number` âœ… |

---

## ğŸ§ª æµ‹è¯•

### æ–°å¢æµ‹è¯•

åˆ›å»ºäº† `test/unit/required-error-fix.test.js`ï¼ŒåŒ…å« **6 ä¸ªæµ‹è¯•ç”¨ä¾‹**ï¼š

1. âœ… é¡¶å±‚å¿…å¡«å­—æ®µï¼šåº”è¯¥æ˜¾ç¤ºæ­£ç¡®çš„é”™è¯¯æ¶ˆæ¯
2. âœ… åµŒå¥—å¯¹è±¡å¿…å¡«å­—æ®µï¼špath åº”è¯¥æ˜¯å®Œæ•´è·¯å¾„ï¼Œmessage åªæ˜¾ç¤ºå­—æ®µå
3. âœ… å¤šå±‚åµŒå¥—å¿…å¡«å­—æ®µï¼šåº”è¯¥æ˜¾ç¤ºæ­£ç¡®çš„è·¯å¾„å’Œæ¶ˆæ¯
4. âœ… å¯¹è±¡æœ¬èº«æ˜¯å¿…å¡«ï¼šåº”è¯¥æ˜¾ç¤ºæ­£ç¡®çš„æ¶ˆæ¯
5. âœ… åŒæ—¶ç¼ºå°‘å¤šä¸ªå­—æ®µï¼šæ¯ä¸ªé”™è¯¯åº”è¯¥æ­£ç¡®æ˜¾ç¤º
6. âœ… ç”¨æˆ·æä¾›çš„çœŸå®åœºæ™¯ï¼šåº”è¯¥æ­£ç¡®å¤„ç†

### æµ‹è¯•ä¿®å¤

**é—®é¢˜**ï¼šnpm test å¤±è´¥ï¼Œä½†å•ç‹¬è¿è¡Œæµ‹è¯•é€šè¿‡

**åŸå› **ï¼šå…¶ä»–æµ‹è¯•ä¿®æ”¹äº†å…¨å±€è¯­è¨€è®¾ç½®ï¼ˆ`Locale.setLocale('zh-CN')`ï¼‰ï¼Œå¯¼è‡´æµ‹è¯•æ±¡æŸ“

**è§£å†³æ–¹æ¡ˆ**ï¼šæ·»åŠ  `beforeEach` é’©å­ï¼Œåœ¨æ¯ä¸ªæµ‹è¯•å‰é‡ç½®è¯­è¨€ä¸ºè‹±æ–‡

```javascript
beforeEach(function() {
  Locale.setLocale('en-US');
});
```

### æµ‹è¯•ç»“æœ

- âœ… **983 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡**ï¼ˆæ–°å¢ 6 ä¸ªï¼‰
- âœ… æ— å›å½’é—®é¢˜
- âœ… è¦†ç›–æ‰€æœ‰é”™è¯¯ç±»å‹

---

## ğŸ“ è·¯å¾„åˆ†éš”ç¬¦è¯´æ˜

### ä¸ºä»€ä¹ˆä½¿ç”¨ `/` è€Œä¸æ˜¯ `.`ï¼Ÿ

**å›ç­”**ï¼šéµå¾ª **JSON Pointer (RFC 6901)** æ ‡å‡†

#### å¯¹æ¯”åˆ†æ

| ä½¿ç”¨ `/`ï¼ˆJSON Pointerï¼‰ | ä½¿ç”¨ `.`ï¼ˆJavaScript é£æ ¼ï¼‰ |
|-------------------------|---------------------------|
| âœ… ç¬¦åˆ RFC 6901 æ ‡å‡† | âŒ ä¸æ˜¯æ ‡å‡†æ ¼å¼ |
| âœ… ä¸ ajv åŸå§‹æ ¼å¼ä¸€è‡´ | âŒ éœ€è¦é¢å¤–è½¬æ¢ |
| âœ… æ”¯æŒåŒ…å« `.` çš„å­—æ®µå | âŒ æ— æ³•åŒºåˆ†å­—æ®µåä¸­çš„ `.` å’Œåˆ†éš”ç¬¦ |
| âœ… JSON Schema ç”Ÿæ€ç³»ç»Ÿé€šç”¨ | âŒ å¯èƒ½ä¸å…¶ä»–å·¥å…·ä¸å…¼å®¹ |

#### ç¤ºä¾‹å¯¹æ¯”

```javascript
// âœ… ä½¿ç”¨ / (JSON Pointer æ ‡å‡†)
path: "user/profile/age"           // æ¸…æ™°
path: "config/version"             // æ˜ç¡®
path: "api/v1.2.3/endpoint"        // å­—æ®µååŒ…å« . ä¹Ÿæ²¡é—®é¢˜

// âŒ ä½¿ç”¨ . (JavaScript é£æ ¼)
path: "user.profile.age"           // éæ ‡å‡†
path: "api.v1.2.3.endpoint"        // æ­§ä¹‰ï¼æ— æ³•åŒºåˆ†
```

#### AJV åŸå§‹æ ¼å¼

```javascript
{
  instancePath: "/user/profile",   // ajv ä½¿ç”¨ /
  schemaPath: "#/properties/user/properties/profile/required"
}
```

**å‚è€ƒ**ï¼š
- [RFC 6901 - JSON Pointer](https://datatracker.ietf.org/doc/html/rfc6901)
- [JSON Schema](https://json-schema.org/)
- [AJV - JSON Schema Validator](https://ajv.js.org/)

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ç”¨æ³•

```javascript
const { dsl } = require('schema-dsl');

const schema = dsl({
  user: {
    profile: {
      age: "number!"
    }
  }
});

const result = dsl.validate(schema, {
  user: {
    profile: {
      age: "not a number"  // ç±»å‹é”™è¯¯
    }
  }
});

if (!result.valid) {
  console.log(result.errors[0]);
  // {
  //   path: 'user/profile/age',           // å®Œæ•´è·¯å¾„ï¼Œç”¨äºå®šä½
  //   message: 'age should be number',    // å‹å¥½æç¤ºï¼Œåªæ˜¾ç¤ºå­—æ®µå
  //   keyword: 'type'
  // }
}
```

### åµŒå¥—å¯¹è±¡å¿…å¡«å­—æ®µ

```javascript
const schema = dsl({
  project: {
    project_id: "objectId!",
    trip_id: "objectId!"
  }
});

const result = dsl.validate(schema, {
  project: {
    // ç¼ºå°‘ project_id
    trip_id: "69771ab94d7ff6963d1e93ff"
  }
});

console.log(result.errors[0]);
// {
//   path: 'project/project_id',         // âœ… å®Œæ•´è·¯å¾„
//   message: 'project_id is required',  // âœ… åªæ˜¾ç¤ºå­—æ®µå
//   keyword: 'required'
// }
```

---

## ğŸ”„ å‡çº§æŒ‡å—

### ç ´åæ€§å˜æ›´

âŒ **æ— ç ´åæ€§å˜æ›´**

### å…¼å®¹æ€§

âœ… **å®Œå…¨å‘åå…¼å®¹**

- `path` ä»ç„¶åŒ…å«å®Œæ•´è·¯å¾„
- `message` æ ¼å¼æ›´å‹å¥½ï¼ˆåªå½±å“æ˜¾ç¤ºï¼‰
- æ‰€æœ‰ API ä¿æŒä¸å˜

### å‡çº§æ­¥éª¤

```bash
npm install schema-dsl@1.1.7
```

æ— éœ€ä¿®æ”¹ä»£ç ï¼Œç›´æ¥å‡çº§å³å¯ã€‚

---

## ğŸ“¦ ä¿®æ”¹æ–‡ä»¶æ¸…å•

1. **lib/core/ErrorFormatter.js** - æ ¸å¿ƒä¿®å¤
   - ä¼˜åŒ– `fieldName` ç”Ÿæˆé€»è¾‘ï¼ˆç¬¬139-158è¡Œï¼‰
   - ä¼˜åŒ– `label` ç”Ÿæˆé€»è¾‘ï¼ˆç¬¬160-185è¡Œï¼‰

2. **test/unit/required-error-fix.test.js** - æ–°å¢æµ‹è¯•
   - æ–°å¢ 6 ä¸ªæµ‹è¯•ç”¨ä¾‹
   - æ·»åŠ  `beforeEach` é’©å­é¿å…æµ‹è¯•æ±¡æŸ“

3. **CHANGELOG.md** - æ›´æ–°å˜æ›´æ—¥å¿—
   - æ·»åŠ  v1.1.7 ç‰ˆæœ¬ä¿¡æ¯

4. **changelogs/v1.1.7.md** - è¯¦ç»†å˜æ›´æ–‡æ¡£ï¼ˆæœ¬æ–‡ä»¶ï¼‰

5. **package.json** - ç‰ˆæœ¬å·æ›´æ–°ä¸º 1.1.7

---

## ğŸ“š ç›¸å…³èµ„æº

- **ä¿®å¤æ€»ç»“æ–‡æ¡£**: [ERROR-MESSAGE-FIX-SUMMARY.md](../ERROR-MESSAGE-FIX-SUMMARY.md)
- **æµ‹è¯•è„šæœ¬**: `test-all-errors.js`ï¼ˆéªŒè¯æ‰€æœ‰é”™è¯¯ç±»å‹ï¼‰
- **GitHub Issue**: ç”¨æˆ·åé¦ˆçš„åµŒå¥—å¯¹è±¡é”™è¯¯æ¶ˆæ¯é—®é¢˜

---

## ğŸ™ è‡´è°¢

æ„Ÿè°¢ç”¨æˆ·åé¦ˆæ­¤é—®é¢˜ï¼Œå¸®åŠ©æˆ‘ä»¬æ”¹è¿›é”™è¯¯æ¶ˆæ¯çš„å¯è¯»æ€§ï¼

---

**ä¸‹ä¸€æ­¥è®¡åˆ’**ï¼š
- ç»§ç»­ä¼˜åŒ–é”™è¯¯æ¶ˆæ¯æ ¼å¼
- å®Œå–„å¤šè¯­è¨€æ”¯æŒ
- æå‡æµ‹è¯•è¦†ç›–ç‡

**å®Œæ•´å˜æ›´æ—¥å¿—**: [CHANGELOG.md](../CHANGELOG.md)  
**GitHub**: [https://github.com/vextjs/schema-dsl](https://github.com/vextjs/schema-dsl)  
**npm**: [https://www.npmjs.com/package/schema-dsl](https://www.npmjs.com/package/schema-dsl)
