# v1.1.1 å˜æ›´æ—¥å¿—

> **å‘å¸ƒæ—¥æœŸ**: 2026-01-06  
> **ç‰ˆæœ¬å·**: v1.1.1  
> **ç±»å‹**: ğŸ‰ æ–°åŠŸèƒ½

---

## ğŸ“‹ å˜æ›´æ¦‚è§ˆ

| ç±»å‹ | æ•°é‡ | è¯´æ˜ |
|------|------|------|
| ğŸ‰ æ–°åŠŸèƒ½ | 1 | ConditionalBuilder ç‹¬ç«‹æ¶ˆæ¯æ”¯æŒ |
| âš¡ åŠŸèƒ½å¢å¼º | 1 | I18nError å¤šè¯­è¨€é”™è¯¯æŠ›å‡º |

---

## ğŸ‰ æ–°åŠŸèƒ½

### ConditionalBuilder ç‹¬ç«‹æ¶ˆæ¯æ”¯æŒ

**è®©æ¡ä»¶éªŒè¯çš„æ¯ä¸ªåˆ†æ”¯éƒ½æœ‰ç‹¬ç«‹çš„é”™è¯¯æ¶ˆæ¯**

#### é—®é¢˜åœºæ™¯

åœ¨ v1.1.0 ä¹‹å‰ï¼Œæ¡ä»¶éªŒè¯åªèƒ½æœ‰ä¸€ä¸ªç»Ÿä¸€çš„é”™è¯¯æ¶ˆæ¯ï¼š

```javascript
// âŒ v1.1.0ï¼šæ‰€æœ‰æ¡ä»¶å¤±è´¥éƒ½æ˜¾ç¤ºåŒä¸€æ¶ˆæ¯
dsl.if(d => !d)
  .and(d => d.status !== 'active')
  .and(d => d.balance < 100)
  .message('éªŒè¯å¤±è´¥')  // æ— æ³•åŒºåˆ†å…·ä½“å“ªä¸ªæ¡ä»¶å¤±è´¥
  .assert(account);
```

#### è§£å†³æ–¹æ¡ˆ

v1.1.1 æ”¯æŒä¸ºæ¯ä¸ªæ¡ä»¶åˆ†æ”¯è®¾ç½®ç‹¬ç«‹çš„æ¶ˆæ¯ï¼š

```javascript
// âœ… v1.1.1ï¼šæ¯ä¸ªæ¡ä»¶éƒ½æœ‰æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯
dsl.if(d => !d)
  .message('ACCOUNT_NOT_FOUND')  // ç¬¬ä¸€ä¸ªæ¡ä»¶çš„æ¶ˆæ¯
  .and(d => d.status !== 'active')
  .message('ACCOUNT_INACTIVE')   // ç¬¬äºŒä¸ªæ¡ä»¶çš„æ¶ˆæ¯
  .and(d => d.balance < 100)
  .message('INSUFFICIENT_BALANCE')  // ç¬¬ä¸‰ä¸ªæ¡ä»¶çš„æ¶ˆæ¯
  .assert(account);
```

#### å®é™…åº”ç”¨åœºæ™¯

**åœºæ™¯1ï¼šè´¦æˆ·éªŒè¯ - å¤šé‡æ£€æŸ¥**

```javascript
const { dsl } = require('schema-dsl');

// æ£€æŸ¥è´¦æˆ·çš„å¤šä¸ªæ¡ä»¶
function validateAccount(account, amount) {
  dsl.if(d => !d)
    .message('ACCOUNT_NOT_FOUND')
    .and(d => d.status !== 'active')
    .message('ACCOUNT_INACTIVE')
    .and(d => d.balance < amount)
    .message('INSUFFICIENT_BALANCE')
    .assert(account);
}

// ä½¿ç”¨ç¤ºä¾‹
try {
  validateAccount(null, 100);
} catch (error) {
  console.log(error.message);  // "è´¦æˆ·ä¸å­˜åœ¨" (ACCOUNT_NOT_FOUND)
}

try {
  validateAccount({ status: 'suspended', balance: 200 }, 100);
} catch (error) {
  console.log(error.message);  // "è´¦æˆ·æœªæ¿€æ´»" (ACCOUNT_INACTIVE)
}

try {
  validateAccount({ status: 'active', balance: 50 }, 100);
} catch (error) {
  console.log(error.message);  // "ä½™é¢ä¸è¶³" (INSUFFICIENT_BALANCE)
}
```

**åœºæ™¯2ï¼šæƒé™æ£€æŸ¥ - åˆ†å±‚éªŒè¯**

```javascript
function checkPermission(user, resource) {
  dsl.if(d => !d)
    .message('USER_NOT_FOUND')
    .and(d => d.role !== 'admin' && d.role !== 'moderator')
    .message('INSUFFICIENT_ROLE')
    .and(d => !d.permissions.includes(resource))
    .message('PERMISSION_DENIED')
    .assert(user);
}
```

**åœºæ™¯3ï¼šè®¢å•éªŒè¯ - ä¸šåŠ¡è§„åˆ™**

```javascript
function validateOrder(order) {
  dsl.if(d => !d)
    .message('ORDER_NOT_FOUND')
    .and(d => d.status === 'cancelled')
    .message('ORDER_CANCELLED')
    .and(d => d.status === 'completed')
    .message('ORDER_ALREADY_COMPLETED')
    .and(d => d.payment === null)
    .message('PAYMENT_MISSING')
    .and(d => !d.payment.isPaid)
    .message('ORDER_NOT_PAID')
    .assert(order);
}
```

#### API å¢å¼º

**ConditionalBuilder.message()**

```typescript
message(
  code: string,           // é”™è¯¯ä»£ç ï¼ˆæ”¯æŒå¤šè¯­è¨€ï¼‰
  params?: object         // å‚æ•°æ’å€¼ï¼ˆå¯é€‰ï¼‰
): ConditionalBuilder
```

**é“¾å¼è°ƒç”¨ç¤ºä¾‹**

```javascript
dsl.if(condition1)
  .message('ERROR_1')
  .and(condition2)
  .message('ERROR_2', { param: 'value' })
  .and(condition3)
  .message('ERROR_3')
  .assert(data);
```

---

## âš¡ åŠŸèƒ½å¢å¼º

### I18nError ç»Ÿä¸€å¤šè¯­è¨€é”™è¯¯æŠ›å‡º

**ä¸šåŠ¡ä»£ç ä¸­ç»Ÿä¸€çš„å¤šè¯­è¨€é”™è¯¯å¤„ç†**

#### æ ¸å¿ƒ API

```javascript
const { I18nError, dsl } = require('schema-dsl');

// æ–¹å¼1ï¼šç›´æ¥æŠ›å‡º
I18nError.throw('account.notFound');

// æ–¹å¼2ï¼šå¸¦å‚æ•°æ’å€¼
I18nError.throw('account.insufficientBalance', {
  balance: 50,
  required: 100
});

// æ–¹å¼3ï¼šæ–­è¨€é£æ ¼ï¼ˆæ¨èï¼‰
I18nError.assert(account, 'account.notFound');
I18nError.assert(
  account.balance >= 100,
  'account.insufficientBalance',
  { balance: account.balance, required: 100 }
);

// æ–¹å¼4ï¼šå¿«æ·æ–¹æ³•
dsl.error.throw('user.noPermission');
dsl.error.assert(user.role === 'admin', 'user.noPermission');
```

#### Express/Koa é›†æˆ

```javascript
// é”™è¯¯å¤„ç†ä¸­é—´ä»¶
app.use((error, req, res, next) => {
  if (error instanceof I18nError) {
    return res.status(error.statusCode).json(error.toJSON());
  }
  next(error);
});

// ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨
app.post('/withdraw', (req, res) => {
  const account = getAccount(req.user.id);
  I18nError.assert(account, 'account.notFound');
  I18nError.assert(
    account.balance >= req.body.amount,
    'account.insufficientBalance',
    { balance: account.balance, required: req.body.amount }
  );
  // éªŒè¯é€šè¿‡ï¼Œç»§ç»­å¤„ç†...
});
```

#### å†…ç½®é”™è¯¯ä»£ç 

**é€šç”¨é”™è¯¯**:
- `error.notFound` - èµ„æºä¸å­˜åœ¨
- `error.forbidden` - ç¦æ­¢è®¿é—®
- `error.unauthorized` - æœªæˆæƒ

**è´¦æˆ·é”™è¯¯**:
- `account.notFound` - è´¦æˆ·ä¸å­˜åœ¨
- `account.insufficientBalance` - ä½™é¢ä¸è¶³
- `account.inactive` - è´¦æˆ·æœªæ¿€æ´»

**ç”¨æˆ·é”™è¯¯**:
- `user.notFound` - ç”¨æˆ·ä¸å­˜åœ¨
- `user.noPermission` - æ— æƒé™

**è®¢å•é”™è¯¯**:
- `order.notPaid` - è®¢å•æœªæ”¯ä»˜
- `order.paymentMissing` - ç¼ºå°‘æ”¯ä»˜ä¿¡æ¯

---

## ğŸ“š æ–‡æ¡£æ›´æ–°

- âœ… æ–°å¢æ¡ä»¶éªŒè¯ç‹¬ç«‹æ¶ˆæ¯æ–‡æ¡£
- âœ… æ–°å¢ I18nError ä½¿ç”¨æŒ‡å—
- âœ… æ›´æ–° Express/Koa é›†æˆç¤ºä¾‹
- âœ… æ·»åŠ å†…ç½®é”™è¯¯ä»£ç åˆ—è¡¨

---

## ğŸ”„ ç ´åæ€§å˜æ›´

**æ— ç ´åæ€§å˜æ›´** - æ‰€æœ‰æ–°åŠŸèƒ½éƒ½æ˜¯å‘åå…¼å®¹çš„ã€‚

æ—§çš„ç”¨æ³•ä»ç„¶æœ‰æ•ˆï¼š

```javascript
// âœ… æ—§ç”¨æ³•ä»ç„¶æœ‰æ•ˆ
dsl.if(condition)
  .message('ERROR')  // ç»Ÿä¸€æ¶ˆæ¯
  .and(condition2)
  .assert(data);
```

---

## ğŸ¯ å‡çº§æŒ‡å—

### ä» v1.1.0 å‡çº§åˆ° v1.1.1

```bash
npm install schema-dsl@1.1.1
```

**å¯é€‰ï¼šä½¿ç”¨ç‹¬ç«‹æ¶ˆæ¯**

```javascript
// ä¹‹å‰ï¼ˆv1.1.0ï¼‰ï¼šç»Ÿä¸€æ¶ˆæ¯
dsl.if(d => !d)
  .and(d => d.status !== 'active')
  .message('éªŒè¯å¤±è´¥')
  .assert(account);

// ç°åœ¨ï¼ˆv1.1.1ï¼‰ï¼šç‹¬ç«‹æ¶ˆæ¯ï¼ˆæ¨èï¼‰
dsl.if(d => !d)
  .message('ACCOUNT_NOT_FOUND')
  .and(d => d.status !== 'active')
  .message('ACCOUNT_INACTIVE')
  .assert(account);
```

**å¯é€‰ï¼šä½¿ç”¨ I18nError**

```javascript
// ä¹‹å‰ï¼šæ‰‹åŠ¨æŠ›å‡ºé”™è¯¯
if (!account) {
  throw new Error('è´¦æˆ·ä¸å­˜åœ¨');
}

// ç°åœ¨ï¼šä½¿ç”¨ I18nErrorï¼ˆæ”¯æŒå¤šè¯­è¨€ï¼‰
I18nError.assert(account, 'account.notFound');
```

---

## ğŸ“¦ ä¾èµ–å˜æ›´

**æ— ä¾èµ–å˜æ›´**

---

## ğŸ”— ç›¸å…³é“¾æ¥

- [GitHub Repository](https://github.com/vextjs/schema-dsl)
- [npm Package](https://www.npmjs.com/package/schema-dsl)
- [æ¡ä»¶éªŒè¯æ–‡æ¡£](../docs/conditional-api.md)
- [I18nError ç¤ºä¾‹](../examples/i18n-error.examples.js)

---

**å‘å¸ƒè€…**: schema-dsl Team  
**å‘å¸ƒæ—¶é—´**: 2026-01-06  
**ä¸‹ä¸€ç‰ˆæœ¬**: v1.1.2

